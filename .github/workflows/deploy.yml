name: Deploy Discord AI Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Deployment Artifact
        run: |
          zip -r deploy.zip . -x "*.git*" "node_modules/*" ".env" ".env.sample" "tests/*" "verify_manual_guide.js"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Copy Artifact to Server
        run: scp deploy.zip ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/${{ secrets.SERVER_USER }}/deploy.zip

      - name: Deploy on Server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            # Define target directory
            TARGET_DIR="/opt/discord-ai-bot"
            TEMP_ZIP="/home/${{ secrets.SERVER_USER }}/deploy.zip"

            # Create target directory if it doesn't exist (requires sudo first time usually)
            # Assuming the user has write permissions or we use sudo for everything.
            # Using sudo for /opt operations as per the Rust example style.
            
            echo "Deploying to $TARGET_DIR..."

            # 1. Unzip to a temporary location to avoid downtime/mess during unzip
            mkdir -p /tmp/discord-bot-deploy
            unzip -o $TEMP_ZIP -d /tmp/discord-bot-deploy

            # 2. Sync files to target (using rsync if available is better, but mv/cp works)
            # We use sudo to move files into /opt
            sudo mkdir -p $TARGET_DIR
            sudo cp -r /tmp/discord-bot-deploy/* $TARGET_DIR/

            # 3. Cleanup temp
            rm -rf /tmp/discord-bot-deploy
            rm $TEMP_ZIP

            # 4. Install Dependencies & Register Commands
            cd $TARGET_DIR
            echo "Installing dependencies..."
            sudo npm ci --production
            
            echo "Registering Slash Commands..."
            # Assumes .env exists in TARGET_DIR or is loaded via environment variables
            # We run with sudo to ensure access if running as root, or pass -E if env vars are needed from current shell (unlikely for .env file approach)
            sudo npm run register

            # 5. Restart Service (PM2)
            echo "Restarting service..."
            # Assuming the process is already managed by pm2 under the current user.
            # If standard setup, no sudo needed for pm2 unless global with specific permissions.
            # We use 'pm2 restart all' or by name 'discord-ai-bot'. 
            # Using 'discord-ai-bot' as the identifier.
            pm2 restart discord-ai-bot || pm2 restart app.js || echo "PM2 restart failed, check process name"
          EOF
