name: Deploy Discord AI Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy Application
        run: |
          # Define target directory
          TARGET_DIR="/opt/zavier-sama"

          # Create/Ensure target directory permissions
          if [ ! -d "$TARGET_DIR" ]; then
              echo "Creating target directory..."
              sudo mkdir -p $TARGET_DIR
              sudo chown -R $USER:$USER $TARGET_DIR
          fi
          
          # Force ownership to current runner user
          sudo chown -R $USER:$USER $TARGET_DIR

          echo "Deploying to $TARGET_DIR..."
          
          # Sync files: 
          # We use rsync for efficiency if available, or cp. 
          # Exclude .git and node_modules to keep copy clean/fast (npm ci will rebuild)
          rsync -av --exclude='.git' --exclude='node_modules' --exclude='.env' . $TARGET_DIR/

          # Prepare Target
          cd $TARGET_DIR
          
          echo "Installing dependencies..."
          # Install dependencies locally on server
          npm ci --production

          echo "Registering Slash Commands..."
          npm run register

          echo "Restarting service..."
          # Restart PM2 process
          pm2 restart zavier-sama || pm2 restart app.js || echo "PM2 restart failed, check process name"
